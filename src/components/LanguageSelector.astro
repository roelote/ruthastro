---
// Selector de idiomas compacto para header
---

<div class="flex items-center gap-1.5">
  <button 
    data-lang="es"
    class="lang-btn active"
    title="Español"
  >
    <img 
      src="https://flagcdn.com/w20/es.png" 
      alt="ES" 
      class="w-5 h-5 rounded-sm"
    />
  </button>
  <span class="text-gray-400">|</span>
  <button 
    data-lang="en"
    class="lang-btn"
    title="English"
  >
    <img 
      src="https://flagcdn.com/w20/us.png" 
      alt="EN" 
      class="w-5 h-5 rounded-sm"
    />
  </button>
  <span class="text-gray-400">|</span>
  <button 
    data-lang="pt"
    class="lang-btn"
    title="Português"
  >
    <img 
      src="https://flagcdn.com/w20/br.png" 
      alt="PT" 
      class="w-5 h-5 rounded-sm"
    />
  </button>
</div>

<style>
  .lang-btn {
    opacity: 0.6;
    transition: opacity 0.3s;
  }

  .lang-btn:hover {
    opacity: 1;
  }

  .lang-btn.active {
    opacity: 1;
    border: 2px solid #15803d;
    border-radius: 3px;
  }

  .translating-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.3);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 9999;
  }

  .translating-message {
    background: white;
    padding: 20px 40px;
    border-radius: 8px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
  }
</style>

<script is:inline>
  function initTranslate() {
    const langMap = {
      'en': 'en-US',
      'pt': 'pt-BR',
      'es': 'es'
    };

    function setCookie(name, value, days) {
      const expires = new Date();
      expires.setTime(expires.getTime() + days * 24 * 60 * 60 * 1000);
      document.cookie = name + '=' + value + ';expires=' + expires.toUTCString() + ';path=/';
    }

    function getCookie(name) {
      const nameEQ = name + '=';
      const ca = document.cookie.split(';');
      for (let i = 0; i < ca.length; i++) {
        let c = ca[i];
        while (c.charAt(0) === ' ') c = c.substring(1, c.length);
        if (c.indexOf(nameEQ) === 0) return c.substring(nameEQ.length, c.length);
      }
      return null;
    }

    async function translateText(text, targetLang) {
      try {
        const response = await fetch(`https://api.mymemory.translated.net/get?q=${encodeURIComponent(text)}&langpair=es|${langMap[targetLang]}`);
        const data = await response.json();
        return data.responseData.translatedText;
      } catch (error) {
        console.error('Translation error:', error);
        return text;
      }
    }

    async function translatePage(targetLang) {
      if (targetLang === 'es') {
        setCookie('site_lang', 'es', 365);
        window.location.reload();
        return;
      }

      // Mostrar overlay de carga
      const overlay = document.createElement('div');
      overlay.className = 'translating-overlay';
      overlay.innerHTML = '<div class="translating-message">Traduciendo...</div>';
      document.body.appendChild(overlay);

      setCookie('site_lang', targetLang, 365);

      // Obtener todos los elementos de texto
      const textElements = document.querySelectorAll('p, h1, h2, h3, h4, h5, h6, span, a, li, td, th, button, label');
      const translations = new Map();

      // Traducir en lotes
      for (const element of textElements) {
        if (element.children.length === 0 && element.textContent.trim()) {
          const originalText = element.textContent.trim();
          if (!translations.has(originalText)) {
            const translated = await translateText(originalText, targetLang);
            translations.set(originalText, translated);
            element.textContent = translated;
          } else {
            element.textContent = translations.get(originalText);
          }
        }
      }

      // Ocultar overlay
      overlay.remove();
    }

    const langButtons = document.querySelectorAll('.lang-btn');
    
    langButtons.forEach(btn => {
      btn.addEventListener('click', function() {
        const lang = this.getAttribute('data-lang');
        
        langButtons.forEach(b => b.classList.remove('active'));
        this.classList.add('active');
        
        translatePage(lang);
      });
    });

    // Detectar idioma actual
    const currentLang = getCookie('site_lang') || 'es';
    document.querySelector(`[data-lang="${currentLang}"]`)?.classList.add('active');
    if (currentLang !== 'es') {
      document.querySelectorAll('.lang-btn').forEach(b => {
        if (b.getAttribute('data-lang') !== currentLang) {
          b.classList.remove('active');
        }
      });
    }
  }

  // Ejecutar cuando el DOM esté listo
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initTranslate);
  } else {
    initTranslate();
  }
</script>
